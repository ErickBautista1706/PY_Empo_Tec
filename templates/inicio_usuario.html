{% extends 'baseV2.html' %}

{% block title %}Bienvenido/a, {{ usuario.Nombre }}{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-end align-items-center">
        <div class="col-md-auto">
            <div class="dropdown">
                <button class="dropbtn">
                    {% if session['usuario'].Imagen %}
                    <img src="{{ url_for('static', filename='images/Usuarios/' + session['usuario'].Imagen) }}"
                        alt="Foto de perfil" class="img-fluid rounded-circle profile-image">
                    {% else %}
                    <img src="{{ url_for('static', filename='images/Usuarios/default_profile_image.jpg') }}"
                        alt="Foto de perfil predeterminada" class="img-fluid rounded-circle profile-image">
                    {% endif %}
                    {{ usuario.Nombre }}
                </button>
                <div class="dropdown-content">
                    <a href="/logout">Cerrar Sesión</a>
                </div>
            </div>
        </div>
    </div>
</div>
<br>
<div class="row card-equal-height justify-content-center">
    {% for curso in cursos_aleatorios %}
    <div class="col-md-4">
        <div class="card cardsIndex fixedHeightCard">
            <img src="{{ url_for('static', filename='images/Cursos/' + curso.imagen) }}" class="card-img-top"
                alt="{{ curso.titulo }}">
            <div class="card-body">
                <h5 class="card-title">{{ curso.titulo }}</h5>
                <p class="card-text">{{ curso.descripcion }}</p>
                <span class="curso-id" style="display: none;">{{ curso.id }}</span> 
            </div>
            <div class="card-footer">
                <button type="button" class="btn btnCardsIndex" 
                    data-id="{{ curso.id }}" 
                    data-usuario-id="{{ session['usuario'].ID }}"
                    data-curso-id="{{ curso.id }}">
                Ver curso
            </button>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<div class="modal fade" id="modalCurso" tabindex="-1" role="dialog" aria-labelledby="modalCursoLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalCursoLabel"></h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <img id="imagenCurso" class="img-fluid" alt="Imagen del curso">
                    </div>
                    <div class="col-md-6">
                        <p id="descripcionCurso"></p>
                        <p id="duracionCurso"></p>
                        <p id="nivelCurso"></p>
                        <ul id="listaLecciones"></ul>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="btnInscribirse">Inscribirse</button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<script>
    $(document).ready(function () {
        $(".btnCardsIndex").click(function () {
            var cursoId = $(this).data("id");
            var usuarioId = $(this).data("usuario-id");

            $("#btnInscribirse").data("curso-id", cursoId);
            $("#btnInscribirse").data("usuario-id", usuarioId);
            console.log("mande ids")

            $.ajax({
                url: "/ver_curso/" + cursoId,
                type: "GET",
                success: function (response) {
                    $("#modalCursoLabel").text(response.curso.titulo);
                    $("#imagenCurso").attr("src", "static/images/Cursos/" + response.curso.imagen);
                    $("#descripcionCurso").text(response.curso.descripcion);
                    $("#duracionCurso").text("Duración: " + response.curso.duracion + " horas");
                    $("#nivelCurso").text("Nivel: " + response.curso.nivel);
                    
                    console.log("Lecciones: ", response.lecciones);

                    $("#listaLecciones").empty();
                    for (var i = 0; i < response.lecciones.length; i++) {
                        var leccion = response.lecciones[i];
                        var listItem = $("<li>").text(leccion.titulo + " - " + leccion.descripcion);
                        $("#listaLecciones").append(listItem);
                    }

                    $("#modalCurso").modal("show");
                },
                error: function (error) {
                    console.log("Error al obtener la información del curso:", error);
                }
            });
        });

        $("#btnInscribirse").click(function () {
            // Obtén el ID del curso y del usuario
            var cursoId = $(this).data("curso-id");  // Asegúrate de tener el ID del curso en el botón
            var usuarioId = $(this).data("usuario-id");  // Asegúrate de tener el ID del usuario en el botón
            console.log("recibiendo estas id", cursoId, usuarioId);
            // Realiza una solicitud AJAX para inscribir al usuario en el curso
            $.ajax({
                url: "/inscribir_usuario_curso",
                type: "POST",
                data: {
                    usuarioId: usuarioId,
                    cursoId: cursoId
                },
                success: function (response) {
                    // Manejar la respuesta del servidor si es necesario
                    //console.log("Inscripción exitosa: ", response);
                    //alert("Te has inscrito en el curso exitosamente.");
                    if (response.success) {
                        const toast = Swal.fire({
                            icon: 'success',
                            title: response.message,
                            position: 'top-end',
                            showConfirmButton: false,
                            toast: true,
                            customClass: {
                                title: 'custom-toast-title',
                                popup: 'custom-toast-popup'
                            },
                            onOpen: (toast) => {
                                const progress = toast.querySelector('.custom-toast-progress');
                                progress.style.animationDuration = '3s';
                                progress.style.animationPlayState = 'running';
                            },
                            html: '<div class="custom-toast-progress"></div>'
                        });

                        setTimeout(() => {
                            toast.close();
                        }, 3000);
                    }else {
                        // Si la inscripción no es exitosa, mostrar un mensaje de error
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: response.message
                        });
                    }
                },
                error: function (error) {
                    //console.log("Error al inscribirse en el curso:", error);
                    //alert("Ocurrió un error al intentar inscribirse en el curso. Por favor, inténtalo nuevamente.");
                }
            });
        });




    });


    {% if success %}
  const toast = Swal.fire({
    icon: 'success',
    title: 'La inscripcion al curso ha sido existosa',
    position: 'top-end',
    showConfirmButton: false,
    toast: true,
    customClass: {
      title: 'custom-toast-title',
      popup: 'custom-toast-popup'
    },
    onOpen: (toast) => {
      const progress = toast.querySelector('.custom-toast-progress');
      progress.style.animationDuration = '3s';
      progress.style.animationPlayState = 'running';
    },
    html: '<div class="custom-toast-progress"></div>'
  });

  setTimeout(() => {
    toast.close();
  }, 3000);
{% endif %}

</script>




{% endblock %}